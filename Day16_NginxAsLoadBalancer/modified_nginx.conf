# /etc/nginx/nginx.conf - Customized for Load Balancing

user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;

events {
worker_connections  1024;
}

http {
include       /etc/nginx/mime.types;
default_type  application/octet-stream;

log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                  '$status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for"';

access_log  /var/log/nginx/access.log  main;

sendfile        on;
keepalive_timeout  65;

# ==========================================================
# Load Balancer Configuration Block
# ==========================================================

# 1. Define the upstream group (the pool of backend servers)
upstream backend_stapp01 {
    # Direct traffic to the specific server and port
    server stapp01:6300;
    server stapp02:6300;
    server stapp03:6300;
    # The default load balancing method is 'round-robin'
}

# 2. Configure the public-facing server block (listening on port 80)
server {
    listen 80;
    server_name  _; # This setting catches any domain name

    # Define the root path (/) to proxy requests
    location / {
        # Pass the request to the defined upstream group
        proxy_pass http://backend_stapp01;

        # Recommended headers to ensure the backend app sees the original client IP and host
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Optional: Uncomment and configure this block if you need to expose Nginx status metrics
    # location /nginx_status {
    #    stub_status on;
    #    access_log off;
    #    allow 127.0.0.1; # Allow access only from localhost
    #    deny all;
    # }
}

# ==========================================================

# Load configuration files for additional virtual hosts (if you have them)
include /etc/nginx/conf.d/*.conf;


}